<div class="container mt-4">
  <div class="row justify-content-center">
    <div class="col-md-10 col-lg-8">
      <div class="card">
        <div class="card-header">
          <div class="d-flex justify-content-between align-items-center">
            <div>
              <h4 class="mb-0">
                {{ isEdit ? "Editar Cliente" : "Nuevo Cliente" }}
              </h4>
              @if (viaje) {
              <small class="text-muted">
                Viaje #{{ viaje.id }} - {{ viaje.date | date : "dd/MM/yyyy" }}
              </small>
              }
            </div>
            @if (!isEdit) {
            <button
              type="button"
              class="btn btn-outline-primary btn-sm"
              (click)="toggleClientSearch()"
              [disabled]="loading"
            >
              <i class="fas fa-search"></i> Buscar Cliente
            </button>
            }
          </div>
        </div>
        <div class="card-body">
          @if (error) {
          <div class="alert alert-danger" role="alert">
            {{ error }}
          </div>
          }

          <!-- Modal de búsqueda de clientes -->
          @if (showClientSearch) {
          <div class="modal-backdrop show" (click)="toggleClientSearch()"></div>
          <div class="modal show d-block" tabindex="-1" role="dialog">
            <div class="modal-dialog modal-lg" role="document">
              <div class="modal-content">
                <div class="modal-header">
                  <h5 class="modal-title">
                    <i class="fas fa-search"></i> Buscar Cliente Existente
                  </h5>
                  <button
                    type="button"
                    class="btn-close"
                    (click)="toggleClientSearch()"
                    aria-label="Close"
                  ></button>
                </div>
                <div class="modal-body">
                  <div class="mb-3">
                    <label for="searchTerm" class="form-label"
                      >Buscar por nombre:</label
                    >
                    <div class="input-group">
                      <input
                        type="text"
                        class="form-control"
                        id="searchTerm"
                        [(ngModel)]="searchTerm"
                        (input)="searchClients()"
                        placeholder="Escribe al menos 2 caracteres..."
                        [disabled]="searching"
                      />
                      <button
                        class="btn btn-outline-secondary"
                        type="button"
                        (click)="clearSearch()"
                        [disabled]="searching"
                      >
                        <i class="fas fa-times"></i>
                      </button>
                    </div>
                  </div>

                  @if (searching) {
                  <div class="text-center">
                    <div class="spinner-border spinner-border-sm" role="status">
                      <span class="visually-hidden">Buscando...</span>
                    </div>
                    <span class="ms-2">Buscando clientes...</span>
                  </div>
                  } @else if (searchResults.length > 0) {
                  <div class="table-responsive">
                    <table class="table table-hover">
                      <thead class="table-light">
                        <tr>
                          <th>Nombre</th>
                          <th>Cédula</th>
                          <th>Teléfono</th>
                          <th>Provincia</th>
                          <th>Acción</th>
                        </tr>
                      </thead>
                      <tbody>
                        @for (cliente of searchResults; track cliente.id) {
                        <tr>
                          <td>{{ cliente.name }}</td>
                          <td>{{ cliente.identity_card || "-" }}</td>
                          <td>{{ cliente.phone || "-" }}</td>
                          <td>{{ cliente.destination }}</td>
                          <td>
                            <button
                              class="btn btn-primary btn-sm"
                              (click)="selectClient(cliente)"
                            >
                              <i class="fas fa-check"></i> Seleccionar
                            </button>
                          </td>
                        </tr>
                        }
                      </tbody>
                    </table>
                  </div>
                  } @else if (searchTerm.length >= 2) {
                  <div class="alert alert-info" role="alert">
                    <i class="fas fa-info-circle"></i>
                    No se encontraron clientes con ese nombre.
                  </div>
                  } @else {
                  <div class="alert alert-secondary" role="alert">
                    <i class="fas fa-search"></i>
                    Escribe al menos 2 caracteres para buscar clientes.
                  </div>
                  }
                </div>
                <div class="modal-footer">
                  <button
                    type="button"
                    class="btn btn-secondary"
                    (click)="toggleClientSearch()"
                  >
                    Cancelar
                  </button>
                </div>
              </div>
            </div>
          </div>
          }

          <form (ngSubmit)="onSubmit()" #clienteForm="ngForm">
            <div class="row">
              <!-- Columna izquierda -->
              <div class="col-md-6">
                <div class="mb-3">
                  <label for="number" class="form-label"
                    >Número de Cliente *</label
                  >
                  <input
                    type="number"
                    class="form-control"
                    id="number"
                    name="number"
                    [(ngModel)]="cliente.number"
                    min="1"
                    required
                    [disabled]="loading"
                  />
                </div>

                <div class="mb-3">
                  <label for="name" class="form-label"
                    >Nombre de Cliente *</label
                  >
                  <input
                    type="text"
                    class="form-control"
                    id="name"
                    name="name"
                    [(ngModel)]="cliente.name"
                    required
                    [disabled]="loading"
                  />
                </div>

                <div class="mb-3">
                  <label for="identity_card" class="form-label"
                    >Carnet de ID</label
                  >
                  <input
                    type="number"
                    class="form-control"
                    id="identity_card"
                    name="identity_card"
                    [(ngModel)]="cliente.identity_card"
                    [disabled]="loading"
                  />
                </div>

                <div class="mb-3">
                  <label for="destination" class="form-label">Destino *</label>
                  <ng-select
                    [items]="getProvincias()"
                    bindLabel="name"
                    bindValue="code"
                    placeholder="Selecciona una provincia"
                    [(ngModel)]="cliente.destination"
                    name="destination"
                    required
                    [disabled]="loading"
                    searchable="true"
                    class="form-control bootstrap-select"
                  >
                  </ng-select>
                </div>
              </div>

              <!-- Columna derecha -->
              <div class="col-md-6">
                <div class="mb-3">
                  <label for="packages" class="form-label"
                    >Número de Paquetes *</label
                  >
                  <input
                    type="number"
                    class="form-control"
                    id="packages"
                    name="packages"
                    [(ngModel)]="cliente.packages"
                    min="1"
                    required
                    [disabled]="loading"
                  />
                </div>

                <div class="mb-3">
                  <label for="family_name" class="form-label">Familiar</label>
                  <input
                    type="text"
                    class="form-control"
                    id="family_name"
                    name="family_name"
                    [(ngModel)]="cliente.family_name"
                    [disabled]="loading"
                  />
                </div>

                <div class="mb-3">
                  <label for="phone" class="form-label">Teléfono</label>
                  <input
                    type="number"
                    class="form-control"
                    id="phone"
                    name="phone"
                    [(ngModel)]="cliente.phone"
                    placeholder="Ej: 5385214796"
                    [disabled]="loading"
                  />
                </div>

                <div class="mb-3">
                  <label for="delivered" class="form-label"
                    >Estado de Entrega</label
                  >
                  <div class="form-check">
                    <input
                      class="form-check-input"
                      type="checkbox"
                      id="delivered"
                      name="delivered"
                      [(ngModel)]="cliente.delivered"
                      [disabled]="loading"
                    />
                    <label class="form-check-label" for="delivered">
                      Entregado
                    </label>
                  </div>
                </div>
              </div>
            </div>

            <!-- Dirección (ancho completo) -->
            <div class="mb-3">
              <label for="address" class="form-label">Dirección</label>
              <textarea
                class="form-control"
                id="address"
                name="address"
                [(ngModel)]="cliente.address"
                rows="3"
                placeholder="Dirección a enviar"
                [disabled]="loading"
              >
              </textarea>
            </div>

            <!-- Checkbox para usar dirección en etiquetas -->
            <div class="mb-3">
              <div class="form-check">
                <input
                  class="form-check-input"
                  type="checkbox"
                  id="is_address"
                  name="is_address"
                  [(ngModel)]="cliente.is_address"
                  [disabled]="loading"
                />
                <label class="form-check-label" for="is_address">
                  Usar dirección en etiquetas (en lugar de destino)
                </label>
              </div>
            </div>

            <!-- Anotaciones (ancho completo) -->
            <div class="mb-3">
              <label for="description" class="form-label">Anotaciones</label>
              <textarea
                class="form-control"
                id="description"
                name="description"
                [(ngModel)]="cliente.description"
                rows="3"
                placeholder="Anotaciones adicionales"
                [disabled]="loading"
              >
              </textarea>
            </div>

            <div class="d-flex gap-2">
              <button
                type="submit"
                class="btn btn-primary"
                [disabled]="!clienteForm.form.valid || loading"
              >
                @if (loading) {
                <span
                  class="spinner-border spinner-border-sm me-2"
                  role="status"
                ></span>
                }
                {{ isEdit ? "Actualizar" : "Crear" }} Cliente
              </button>
              <button
                type="button"
                class="btn btn-secondary"
                (click)="cancel()"
                [disabled]="loading"
              >
                Cancelar
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>
</div>
